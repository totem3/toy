#include <stdio.h>
#include <stdint.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include "osfmk/mach/machine.h"
#include "EXTERNAL_HEADERS/mach-o/loader.h"
#include <string.h>

int main()
{
    unsigned int code_bytes = 640 * 1024;
    uint8_t* mem = (uint8_t*) mmap(
            NULL,
            code_bytes,
            PROT_READ | PROT_WRITE | PROT_EXEC,
            MAP_ANONYMOUS | MAP_PRIVATE,
            0,
            0);
    uint64_t offset = 0;
    uint64_t data_offset = 0;
    uint64_t ncmds = 0;
    uint64_t vmaddr = 0x0000000100000000;
    uint64_t vmsize = 0x0000000000001000;

    struct mach_header_64 *header = (struct mach_header_64*)mem;
    header->magic = MH_MAGIC_64;
    header->cputype = (CPU_ARCH_ABI64 | CPU_TYPE_X86);
    header->cpusubtype = CPU_SUBTYPE_LIB64 | CPU_SUBTYPE_X86_64_ALL;
    header->ncmds = 0;
    header->sizeofcmds = 0;
    header->filetype = MH_EXECUTE;
    header->flags = MH_PIE | MH_TWOLEVEL | MH_PRELOAD;

    offset += sizeof(struct mach_header_64);

    struct segment_command_64 *zero = (struct segment_command_64*)(mem + offset);
    zero->cmd = LC_SEGMENT_64;
    zero->cmdsize = sizeof(struct segment_command_64);
    zero->vmsize = vmaddr;
    strcpy(zero->segname, SEG_PAGEZERO);
    offset += sizeof(struct segment_command_64);
    ncmds += 1;

    struct segment_command_64 *text = (struct segment_command_64*)(mem + offset);
    text->cmd = LC_SEGMENT_64;
    text->cmdsize = sizeof(struct segment_command_64);
    strncpy(text->segname, SEG_TEXT, 16);
    text->vmaddr = vmaddr;
    text->vmsize = vmsize;
    text->fileoff = 0;
    text->filesize = 4096;
    text->maxprot = 0x7;
    text->initprot = 0x5;
    uint32_t nsects = 0;
    text->nsects = nsects;
    text->flags = 0;

    offset += sizeof(struct segment_command_64);
    ncmds += 1;

    uint8_t prg[] = {
        0x48, 0xc7, 0xc0, 0x04, 0x00, 0x00, 0x02,
        0x48, 0xc7, 0xc7, 0x01, 0x00, 0x00, 0x00,
        0x48, 0x8d, 0x35, 0x19, 0x00, 0x00, 0x00,
        0x48, 0xc7, 0xc2, 0x0d, 0x00, 0x00, 0x00,
        0x0f, 0x05,
        0x48, 0xc7, 0xc0, 0x01, 0x00, 0x00, 0x02,
        0x48, 0xc7, 0xc7, 0x00, 0x00, 0x00, 0x00,
        0x0f, 0x05,
        0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x0a, 0x00,
    };


    size_t prgsize = sizeof(prg);

    struct section_64 *text_sect = (struct section_64*)(mem + offset);
    strncpy(text_sect->sectname, SECT_TEXT, 16);
    strncpy(text_sect->segname, SEG_TEXT, 16);
    text_sect->addr = 0;
    text_sect->size = prgsize;
    text_sect->offset = 0;
    text_sect->align = 0;
    text_sect->flags = 0x80000400;

    offset += sizeof(struct section_64);
    data_offset += text_sect->size;
    nsects += 1;

    text->nsects = nsects;
    text->cmdsize += (sizeof(struct section_64) * nsects);

    uint8_t entry[] = {
        0x05, 0x00, 0x00, 0x00,
        0xb8, 0x00, 0x00, 0x00,
        0x04, 0x00, 0x00, 0x00,
        0x2a, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xb0, 0x0f, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    };
    memcpy(mem + offset, entry, 184);

    offset += 184;
    ncmds += 1;

    header->ncmds = ncmds;
    header->sizeofcmds = offset - sizeof(struct mach_header_64);
    if (offset < 0xfb0) {
        offset += (0xfb0 - offset);
    }

    text_sect->addr = vmaddr + offset;
    text_sect->offset = offset;

    memcpy((mem+offset), prg, sizeof(prg));
    offset += text_sect->size;

    char* filename = "foo";
    FILE *fp = fopen(filename, "wb");
    fwrite(mem, 1, 8192, fp);
    fclose(fp);
    chmod(filename, 0777);
    return 0;
}
